if not getgenv().AutoDribbleSettings then
    getgenv().AutoDribbleSettings = {
        Enabled = true,
        Range = 30,
        DebounceTime = 0.1
    }
end

local Settings = getgenv().AutoDribbleSettings
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer or Players.PlayerAdded:Wait()
local BallService = ReplicatedStorage:WaitForChild("Packages"):WaitForChild("Knit"):WaitForChild("Services"):WaitForChild("BallService"):WaitForChild("RE"):WaitForChild("Dribble")
local AnimationsModule = require(ReplicatedStorage:WaitForChild("Assets"):WaitForChild("Animations"))

local Character, HRP, Humanoid
local function getCharacter()
    local char = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    return char, char:WaitForChild("HumanoidRootPart"), char:WaitForChild("Humanoid")
end

Character, HRP, Humanoid = getCharacter()
LocalPlayer.CharacterAdded:Connect(function()
    Character, HRP, Humanoid = getCharacter()
end)

local function loadDribbleAnimation(style)
    local animId = AnimationsModule.Dribbles and AnimationsModule.Dribbles[style]
    if animId then
        local anim = Instance.new("Animation")
        anim.AnimationId = animId
        return Humanoid:LoadAnimation(anim)
    end
end

local function isOpponentSliding(player)
    if player ~= LocalPlayer and player.Character then
        local char = player.Character
        local sliding = char:FindFirstChild("Values") and char.Values:FindFirstChild("Sliding")
        local oppHumanoid = char:FindFirstChildOfClass("Humanoid")
        return (sliding and sliding.Value) or (oppHumanoid and oppHumanoid.MoveDirection.Magnitude > 0 and oppHumanoid.WalkSpeed == 0)
    end
end

local function isOpponent(player)
    return LocalPlayer.Team and player.Team and LocalPlayer.Team ~= player.Team
end

local lastDribbleTime = 0
local function autoDribble(distance)
    if not (Settings.Enabled and Character and Character:FindFirstChild("Values")) then return end
    if not Character.Values:FindFirstChild("HasBall") or not Character.Values.HasBall.Value then return end

    local now = tick()
    if now - lastDribbleTime < Settings.DebounceTime then return end
    lastDribbleTime = now

    BallService:FireServer()

    local style = LocalPlayer:FindFirstChild("PlayerStats") and LocalPlayer.PlayerStats:FindFirstChild("Style")
    if style then
        local anim = loadDribbleAnimation(style.Value)
        if anim then
            anim:Play()
            anim:AdjustSpeed(math.clamp(1 + (10 - distance) / 10, 1, 2))
        end
    end

    local football = workspace:FindFirstChild("Football")
    if football and HRP then
        football.AssemblyLinearVelocity = Vector3.zero
        football.CFrame = HRP.CFrame * CFrame.new(0, -2.5, 0)
    end
end

RunService.Heartbeat:Connect(function()
    if not (Settings.Enabled and Character and HRP) then return end

    for _, player in ipairs(Players:GetPlayers()) do
        if isOpponent(player) and isOpponentSliding(player) then
            local oppHRP = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
            if oppHRP then
                local dist = (oppHRP.Position - HRP.Position).Magnitude
                if dist < Settings.Range then
                    autoDribble(dist)
                    break
                end
            end
        end
    end
end)